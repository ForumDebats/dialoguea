var BroadcastFactory=["$rootScope",function(k){return{message:"",prepForBroadcast:function(f,c){this.message=f;this.broadcastItem(c)},broadcastItem:function(f){k.$broadcast(f)}}}],getImg=["$http",function(k){return{restrict:"A",require:"ngModel",link:function(f,c,b,l){l.$parsers.push(function(b){if(b&&urlValid(b))return b.startsWith("http://")||(b="http://"+b),k.get(b).success(function(b,a){f.message="ok"+a}).error(function(b,a){f.message="err"+b}),b})}}}];
function errSrc(){return{link:function(k,f,c,b){f.bind("error",function(){c.src!=c.errSrc&&(c.$set("src",c.errSrc),k.noImgUrl=!0)})}}}
var AdmDebatCtrl=["Debat","$http",function(k,f){var c=this;c.message="";c.debats=[];f.get("apiadm/debats").success(function(b){b.length?(c.message="",c.debats=b):c.message="Aucun d\u00e9bat ouvert"}).error(function(b){c.message="Tous les d\u00e9bats sont ferm\u00e9s";console_dbg(b)})["finally"](function(){$(".loading").hide()});c.showConfirmClose=function(b){c.debats.forEach(function(b){b.closing=!1;b.reopening=!1});b.dateFermeture?b.reopening=!0:b.closing=!0};c.closeDebat=function(b,k){f.post("apiadm/openclosedebate",
{id:b._id,close:k}).then(function(h){var f=c.debats.indexOf(b);c.debats[f].dateFermeture=h.data.dateFermeture;b.reopening=b.closing=!1},function(b){c.message=b})};c["delete"]=function(b){f.post("apiadm/deldebate",{id:c.debats[b]._id});c.debats.splice(b,1)}}],OpenDebatCtrl=["Group","Docu","Cmt","Debat","$resource","$scope","$rootScope","$sce","$http","$location","$window","$state",function(k,f,c,b,l,h,m,a,g,q,e,p){p.go("opendebat.groupList");var n=this;n.docs=[];n.grps=[];n.section="groups";h.hasSelection=
!1;m.selectedDoc=null;m.GrpSelection={};h.$on("groupSelectionForDebate",function(){h.hasSelection=_.keys(m.GrpSelection).length;h.selectedGroups=_.values(m.GrpSelection)});h.$on("DocSelectionForDebate",function(){h.selectedDoc=m.selectedDoc});n.back=function(){window.history.back()};n.select=function(a){n.section=a};n.isSection=function(a){return n.section==a};n.switchToDocs=function(){n.section="docs"};h.openDebat=function(){m.selectedDoc&&_.keys(m.GrpSelection).length&&p.go("predebat",{docId:m.selectedDoc._id})}}],
GroupsListCtrl=["Group","$scope","$location","$rootScope","$state",function(k,f,c,b,l){var h=this;h.newGroup=null;h.groups=[];h.selectedGroup=null;h.errmsg="";h.editing=!1;f.selector=l.$current.data.selector;f.statePrefix=l.$current.data.section;this.getList=function(){k.query(function(c){h.groups=c;$(".loading").hide();var a=b.GrpSelection;_.each(h.groups,function(g){_.contains(_.keys(a),g._id)&&(g.selected=!0)})})};h.getList();f.openGroup=function(b){l.go(f.statePrefix+"group",{groupId:b})};this.addGrp=
function(){h.errmsg="";var b=h.newGroup.trim();if(b.length&&b.length){var a=new k({name:b});a.$save().then(function(g){a.openDebats=0;a.closedDebats=0;h.groups.unshift(a)})["catch"](function(a){h.errmsg="Erreur ! ";console_dbg("error saving obj",a)})}};this.toggleGroup=function(c){_.contains(_.keys(b.GrpSelection),c._id)?(c.selected=!1,delete b.GrpSelection[c._id]):(c.selected=!0,b.GrpSelection[c._id]=c.name);console_dbg(b.GrpSelection);b.$broadcast("groupSelectionForDebate")};this.groupSelected=
function(c){console_dbg(b.GrpSelection[c]);return b.GrpSelection[c]}}],GroupCtrl=["Group","$state","$stateParams","$filter","$location",function(k,f,c,b,l){var h=this;h.group=null;h.availDocs=[];h.docs=[];h.debats=[];h.openDebates=[];h.closeDebates=[];h.confirmdelete=!1;h.statePrefix=f.$current.data?f.$current.data.section:"";k.get({id:c.groupId},function(b){h.group=b});this["delete"]=function(){this.group.$delete();l.path("/groupes")}}],AdmCategoriesCtrl=["Cat","Broadcast","$http","$scope","$timeout",
"$filter","$state",function(k,f,c,b,l,h,m){var a=this;a.LISTING=0;a.NEW=1;a.EDITIMG=2;a.status=a.LISTING;a.message="";a.cat=[];a.editingField=null;a.originalCat=null;a.newcat={name:null,img:null,upload:!1,byUrlImg:null,debats:[]};b.message="";b.imgUrl=null;b.statePrefix=m.$current.data.section;b.processing=!1;b.opencat=function(a){m.go(b.statePrefix+"docList",{catId:a})};b.editCat=function(g){b.processing=!1;a.status=a.EDITIMG;a.newcat={name:g.name,img:g.img,upload:!1,byUrlImg:null,debats:g.debats};
a.originalCat=g};this.saveCat=function(){b.processing=!1;var g=a.cat.indexOf(a.originalCat),g=a.cat[g];g.name=a.newcat.name;g.img=a.newcat.img;a.save(g)};b.cancelEdit=function(){b.proccesing=!1;a.status=a.LISTING;a.newcat={name:null,img:null,upload:!1,byUrlImg:null,debats:[]}};b.setImg=function(g){a.newcat.img=validUrlImg(g)?g:"//:0"};k.query({},function(g){g.length?(a.cat=g,g=h("orderBy"),a.cat=g(a.cat,"order",!1)):a.message="Aucune cat\u00e9gorie";$(".loading").hide()});b.confirmDeleteCat=function(g){b.deletingCat=
g;a.status=a.DELETE};this.deleteCat=function(g){b.processing=!1;g=a.cat.indexOf(g);a.cat[g].$remove();a.cat.splice(g,1);a.status=a.LISTING};this.addCat=function(){b.processing=!1;b.noImgUrl&&(a.newcat.imgurl=null);console_dbg(a.newcat);(new k(a.newcat)).$save().then(function(g){a.cat.push(g);a.message=null;a.status=a.LISTING})["catch"](function(g){a.message="Erreur 50 : \u00e9chec \u00e0 la sauvegarde du document";console_dbg("Error",g)})};this.editCatName=function(g){a.errOnUpdate="";var b=a.cat.indexOf(g);
null!=a.editedCat?l(function(){a.editedCat=a.cat[b];a.editingField=g.name;a.originalCat=angular.extend({},a.editedCat)},100):(a.editedCat=a.cat[b],a.editingField=g.name);l(function(){$_(g._id).focus()},100)};this.revertEditing=function(b,c){if(c.$dirty){var e=a.cat.indexOf(b);a.cat[e].name=a.editingField}l(function(){a.editedCat=null},100);$_(b._id).blur()};this.doneEditing=function(b,c){console_dbg("done editing");l(function(){a.editedCat=null},100);if(c.$dirty){c.$setPristine();$_(b._id).blur();
var e=a.cat.indexOf(b);a.save(a.cat[e])}};this.save=function(g){b.processing=!1;g.name.trim().length?g.$update().then(function(){a.status=a.LISTING})["catch"](function(b){console_dbg(b);a.errOnUpdate=b.data&&b.data.err&&11001==b.data.err.code?"Cet identifiant existe d\u00e9j\u00e0":"Erreur \u00e0 l'enregistrement"}):(console_dbg("missing value"),a.errmsg="le nom ne doit pas \u00eatre vide ! ")};b.$on("uploadComplete",function(){console_dbg(f.message);a.newcat.upload=!0;angular.element($_("catImg")).scope().$apply(function(){a.newcat.img=
f.message})});b.tabs=[{title:"Envoyer une image",url:"upFILE.tpl.html"},{title:"T\u00e9l\u00e9charger d'une URL",url:"byURL.tpl.html"}];b.currentTab="upFILE.tpl.html";b.onClickTab=function(a){b.currentTab=a.url};b.isActiveTab=function(a){return a==b.currentTab};b.dragControlListeners={orderChanged:function(b){a.cat.forEach(function(a,b){a.order=b;a.$update()})},containerPositioning:"relative"}}],DocListCtrl=["Docu","Cat","$scope","$location","$rootScope","$stateParams","$state",function(k,f,c,b,l,
h,m){var a=this;a.newDoc=null;a.docs=[];a.selectedDoc=null;a.errmsg="";a.editing=!1;a.LISTING=0;a.NEWDOC=1;a.EDITION=2;a.status=a.LISTING;a.cat={_id:h.catId};c.selector=m.$current.data.selector;c.statePrefix=m.$current.data.section;console_dbg(m);c.CONFIRM=void 0;c.tabs=[{id:"doclist",url:"doclist.tpl.html"},{id:"newdoc",url:"newdoc.tpl.html"},{id:"editdoc",url:"editdoc.tpl.html"}];c.currentTab=c.tabs[0];c.onClickTab=function(a){c.currentTab=c.tabs[a]};c.isActiveTab=function(a){return c.tabs[a]==
c.currentTab};a.getList=function(){f.get({id:a.cat._id},function(b){a.cat=b;k.query({categorie:a.cat._id},function(b){a.docs=b;_.each(a.docs,function(a){var b=_.countBy(a.debats,function(a){return a.status});a.openDebats=b[0]||0;a.closedDebats=b[1]||0})})})};a.cat._id&&a.getList();c.openDoc=function(a){b.path("document/"+a)};this.addDoc=function(){a.errmsg="";var b=a.newDoc.titre1.trim(),f=a.newDoc.titre2.trim(),e=a.newDoc.texte.trim();if(b.length&&f.length&&e.length){var p=new k({titre1:b,titre2:f,
texte:e,categorie:a.cat._id});p.$save().then(function(){a.docs.unshift(p);p.openDebats=0;p.closedDebats=0;a.newDoc="";c.onClickTab(a.LISTING)})["catch"](function(b){a.errmsg="Erreur : \u00e9chec \u00e0 la sauvegarde du document";console_dbg("Error",b)})}};this.removeDoc=function(b){b=this.docs.indexOf(b);a.docs[b].$remove();a.docs.splice(b,1)};this.editDoc=function(b){a.originalDoc=angular.extend({},b);a.originalDoc.$update=b.$update;a.editingId=a.docs.indexOf(b);a.editedDoc=b;console_dbg(a.editedDoc);
c.onClickTab(a.EDITION)};this.doneEditing=function(){var b=a.editedDoc.titre1.trim(),f=a.editedDoc.titre2.trim(),e=a.editedDoc.texte;b.length&&f.length&&e.length?a.editedDoc.$update().then(function(){a.editedDoc=null;c.onClickTab(a.LISTING)}):(console_dbg("missing value"),a.errmsg="erreur")};this.revertEditing=function(){a.editedDoc=a.originalDoc;a.docs[a.editingId]=a.originalDoc;c.onClickTab(a.LISTING)};this.selectDoc=function(a){l.selectedDoc=a;l.$broadcast("DocSelectedForDebate")};this.groupSelected=
function(a){return l.selection[a]};this.getDoc=function(){k.get({id:h.docId},function(b){a.editedDoc=b})};c.tinymceAdminOption={encoding:"UTF-8",language:"fr_FR",menubar:!1,statusbar:!1,autoresize:!1,entity_encoding:"raw",language_url:"lang/fr_FR.js",skin:"tinycystom",skin_url:"/css",resize:!0,height:500,plugins:["image upimage table link anchor code"],toolbar:"undo redo | styleselect | fontsizeselect bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link anchor upimage table code",
file_browser_callback:function(a,b,e,c){$("#upload").click()},image_dimensions:!1,init_instance_callback:function(b){console_dbg("Editor: "+b.id+" initialized.");a.editor=b}}}];function retrieve(k,f,c,b){k.get({id:f},function(b){});b&&b(d)}
var UsersCtrl=["User","Group","$resource","$stateParams","$scope","$http","$timeout","Broadcast",function(k,f,c,b,l,h,m,a){l.field=null;l.processing=!1;var g=$_("newUserBtn"),q=b.groupId,e=this;e.newUser={nom:"",prenom:"",login:"",email:""};e.editedUser=null;e.users=[];e.group=null;e.errmsg="";e.uploadErrmsg="";e.newUsersList=null;e.setLogin=function(){e.newUser.login=(e.newUser.nom+(e.newUser.prenom?"."+e.newUser.prenom[0]:"")).toLowerCase()};f.get({id:q},function(a){e.group=a});e.getList=function(a){k.query({gid:a},
function(a){e.users=a;$(".loading").hide()})};e.getList(q);e.addUser=function(){e.errOnUpdate="";g.disabled=!0;e.errmsg="";if(a||!b){var a=e.newUser.nom.trim(),b=e.newUser.prenom.trim(),c=e.newUser.login.trim(),f=e.newUser.email&&e.newUser.email.trim();if(a.length&&b.length){var h=new k({nom:a,prenom:b,login:c,email:f,gid:q});h.$save().then(function(){e.users.unshift(h);e.newUser="";l.addpersonshow=1}).then(function(){e.group.membres.push(h._id);e.group.$update()})["catch"](function(a){e.newusererrmsg=
a.data&&a.data.code&&11E3==a.data.code?"Cet identifiant existe d\u00e9j\u00e0":"Erreur \u00e0 l'enregistrement"})["finally"](function(){g.disabled=!1})}}};e.removeUser=function(a){e.errOnUpdate="";var b=e.users.indexOf(a);a=e.group.membres.indexOf(a._id);e.group.membres.splice(a,1);e.group.$update();e.users[b].$remove();e.users.splice(b,1)};e.editUser=function(a,b){e.errOnUpdate="";var c=e.users.indexOf(a);e.editedUser=e.users[c];e.editingField=b;e.editingFieldValue=e.editedUser[b];m(function(){$_(b+
a._id).focus()},100)};e.doneEditing=function(a,b,c){e.errmsg="";e.editedUser=null;if(b.$dirty){c.$setPristine();b=e.users.indexOf(a);var f=e.users[b];b=f.nom.trim();c=f.prenom.trim();var g=f.login.trim();b.length&&c.length&&g.length?f.$update().then(function(){})["catch"](function(a){a.data&&a.data.err&&11001==a.data.err.code?e.errmsg="Cet identifiant existe d\u00e9j\u00e0":e.errOnUpdate="Erreur \u00e0 l'enregistrement";f[e.editingField]=e.editingFieldValue}):(e.errmsg="le nom, le pr\u00e9nom et le login doivent \u00eatre indiqu\u00e9s ! ",
e.revertEditing(a))}};e.revertEditing=function(a){a=e.users.indexOf(a);e.users[a][e.editingField]=e.editingFieldValue;e.editedUser=null};e.importList=function(){e.importing=!0;1>e.newUserList.length?e.errmsg="liste invalide":h.post("api/newuserlist",{userlist:e.newUserList,gid:q}).success(function(a){e.getList(q)}).error(function(a){console.log(a);e.listErrMsg=a})["finally"](function(){e.importing=!1;e.newListPopup=!1})};l.$on("uploadComplete",function(){angular.element($_("importResult")).scope().$apply(function(){e.newUserList=
JSON.parse(a.message);e.newListPopup=!0;l.processing=!1})});l.cancelList=function(){e.newListPopup=!1;e.newUserList=null;angular.element($_("addList")).scope().$apply(function(){l.processing=!1})}}];
angular.module("upload",[],function(){}).factory("Broadcast",BroadcastFactory).controller("FileUploadCtrl",["$rootScope","$scope","Broadcast","$translate","$filter",function(k,f,c,b,l){function h(a){console_dbg(a);f.$apply(function(){f.progress=a.lengthComputable?Math.round(100*a.loaded/a.total):"---"})}function m(a){400==a.target.status?alert("Le format du fichier n'est pas support\u00e9"):c.prepForBroadcast(a.target.responseText,"uploadComplete")}function a(a){alert("Une erreur est survenue \u00e0 l'envoi du fichier")}
function g(a){f.$apply(function(){f.progressVisible=!1});alert("L'envoi a \u00e9t\u00e9 annul\u00e9 par l'utilisateur ou le navigateur a \u00e9t\u00e9 d\u00e9connect\u00e9.")}f.setFiles=function(a,b){f.$apply(function(c){c.files=[];for(var f=0;f<a.files.length;f++)c.files.push(a.files[f]);c.progressVisible=!1;c.fileSelected=!0;c.processing=!1;document.getElementById(b).value=c.files[0].name+" ("+l("number")(c.files[0].size/1024,2)+" kB.)"})};f.uploadFile=function(b){var e=new FormData,c;for(c in f.files)e.append("uploadedFile",
f.files[c]);c=new XMLHttpRequest;c.upload.addEventListener("progress",h,!1);c.addEventListener("load",m,!1);c.addEventListener("error",a,!1);c.addEventListener("abort",g,!1);c.open("POST",b);console_dbg("uploading to",b);f.progressVisible=!0;c.send(e)}}]);
var UserFactory=["$resource",function(k){return k("apiadm/users/:id",{id:"@_id"},{update:{method:"PUT"},query:{method:"GET",params:{gid:"@groupId"},isArray:!0}})}],app=angular.module("adminDialoguea","ui.router ngResource ngAnimate as.sortable ui.tinymce ngTouch".split(" ")).factory("authInterceptor",AuthFactory).factory("Broadcast",BroadcastFactory).factory("User",UserFactory).factory("Cat",CatFactory).factory("Debat",DebatFactory).factory("Docu",DocuFactory).factory("Group",GroupFactory).factory("Cmt",
CmtFactory).directive("clickOnce",ClickOnce).directive("userList",function(){return{restrict:"E",templateUrl:"section/admin/user-list.html",controller:"UsersCtrl",controllerAs:"U"}}).directive("ngEnter",ngEnter).directive("ngEscape",ngEscape).filter("usersearch",function(k){return!(-1===k.nom.indexOf($scope.query||"")&&-1===k.prenom.indexOf($scope.query||""))}).directive("groupList",function(){return{restrict:"E",templateUrl:"section/admin/group-list.html",controller:"GroupsListCtrl",controllerAs:"G",
scope:{validation:"@validation",selection:"="}}}).directive("errSrc",errSrc).directive("getImg",getImg).controller("AdmCategoriesCtrl",AdmCategoriesCtrl).controller("AdmDebatsCtrl",AdmDebatCtrl).controller("DocListCtrl",DocListCtrl).controller("GroupsListCtrl",GroupsListCtrl).controller("GroupCtrl",GroupCtrl).controller("UsersCtrl",UsersCtrl).controller("OpenDebatCtrl",OpenDebatCtrl).controller("PreDebatCtrl",PreDebatCtrl).config(["$httpProvider",function(k){k.interceptors.push("authInterceptor")}]).config(ADMINROUTES);
